{{define "header"}}
<div class="nav-header">
    <div class="nav-container">
        <div class="nav-controls">
            {{if and (ne .CurrentPage "workflow") (ne .CurrentPage "about")}}
            <div class="date-picker-container">
                <label for="datePicker" class="date-picker-label">Date:</label>
                <input type="text" id="datePicker" class="date-picker" value="{{.DateValue}}" readonly>
                <button id="todayBtn" class="btn btn-sm btn-outline">Today</button>
            </div>
            {{end}}
            {{if .ShowRefresh}}
            <button class="refresh-btn" onclick="location.reload()">Refresh</button>
            {{end}}
        </div>
        <div class="nav-brand">
            <h1>{{if .PageTitle}}{{.PageTitle}}{{else}}Flowlord Dashboard{{end}}</h1>
        </div>
        <nav class="nav-menu">
            {{if .isLocal}}
            <a href="./alert_preview.html{{if .DateValue}}?date={{.DateValue}}{{end}}" class="nav-link {{if eq .CurrentPage "alert"}}active{{end}}">
                <span class="nav-icon">üö®</span>
                Alerts
            </a>
            <a href="./files_preview.html{{if .DateValue}}?date={{.DateValue}}{{end}}" class="nav-link {{if eq .CurrentPage "files"}}active{{end}}">
                <span class="nav-icon">üìÅ</span>
                Files
            </a>
            <a href="./task_preview.html{{if .DateValue}}?date={{.DateValue}}{{end}}" class="nav-link {{if eq .CurrentPage "task"}}active{{end}}">
                <span class="nav-icon">üìä</span>
                Tasks
            </a>
            <a href="./workflow_preview.html" class="nav-link {{if eq .CurrentPage "workflow"}}active{{end}}">
                <span class="nav-icon">üå≥</span>
                Workflow
            </a>
            <a href="./about_preview.html" class="nav-link {{if eq .CurrentPage "about"}}active{{end}}">
                <span class="nav-icon">‚ÑπÔ∏è</span>
                About
            </a>
            {{else}}
            <a href="/web/alert{{if .DateValue}}?date={{.DateValue}}{{end}}" class="nav-link {{if eq .CurrentPage "alert"}}active{{end}}">
                <span class="nav-icon">üö®</span>
                Alerts
            </a>
            <a href="/web/files{{if .DateValue}}?date={{.DateValue}}{{end}}" class="nav-link {{if eq .CurrentPage "files"}}active{{end}}">
                <span class="nav-icon">üìÅ</span>
                Files
            </a>
            <a href="/web/task{{if .DateValue}}?date={{.DateValue}}{{end}}" class="nav-link {{if eq .CurrentPage "task"}}active{{end}}">
                <span class="nav-icon">üìä</span>
                Tasks
            </a>
            <a href="/web/workflow" class="nav-link {{if eq .CurrentPage "workflow"}}active{{end}}">
                <span class="nav-icon">üå≥</span>
                Workflow
            </a>
            <a href="/web/about" class="nav-link {{if eq .CurrentPage "about"}}active{{end}}">
                <span class="nav-icon">‚ÑπÔ∏è</span>
                About
            </a>
            {{end}}
        </nav>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const datePicker = document.getElementById('datePicker');
    const todayBtn = document.getElementById('todayBtn');
    
    // Dates with data from the server
    const datesWithData = new Set([
        {{range $index, $date := .DatesWithData}}{{if $index}},{{end}}"{{$date}}"{{end}}
    ]);
    
    // Set today's date as default if no date is provided
    if (!datePicker.value) {
        const today = new Date().toISOString().split('T')[0];
        datePicker.value = today;
    }
    
    // Update data indicator
    function updateDataIndicator(date) {
        if (datesWithData.has(date)) {
            datePicker.classList.add('has-data');
        } else {
            datePicker.classList.remove('has-data');
        }
    }
    
    // Initial indicator update
    updateDataIndicator(datePicker.value);
    
    // Create custom date picker dropdown
    const dropdown = document.createElement('div');
    dropdown.id = 'dateDropdown';
    dropdown.className = 'date-dropdown';
    dropdown.style.display = 'none';
    
    // Generate calendar for current month and surrounding dates
    function generateCalendar() {
        const currentDate = datePicker.value ? new Date(datePicker.value + 'T12:00:00') : new Date();
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        let html = '<div class="calendar-header">';
        html += '<button type="button" class="month-nav" data-dir="-1">‚óÄ</button>';
        html += '<span class="month-label">' + currentDate.toLocaleDateString('en-US', {month: 'long', year: 'numeric'}) + '</span>';
        html += '<button type="button" class="month-nav" data-dir="1">‚ñ∂</button>';
        html += '</div>';
        
        html += '<div class="calendar-grid">';
        html += '<div class="day-header">Su</div><div class="day-header">Mo</div><div class="day-header">Tu</div>';
        html += '<div class="day-header">We</div><div class="day-header">Th</div><div class="day-header">Fr</div><div class="day-header">Sa</div>';
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay();
        
        // Add empty cells for days before month starts
        for (let i = 0; i < startDay; i++) {
            html += '<div class="day-cell empty"></div>';
        }
        
        // Add days of month
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            const hasData = datesWithData.has(dateStr);
            const isSelected = dateStr === datePicker.value;
            
            let classes = 'day-cell';
            if (hasData) classes += ' has-data';
            if (isSelected) classes += ' selected';
            
            html += '<div class="' + classes + '" data-date="' + dateStr + '">' + day + '</div>';
        }
        
        html += '</div>';
        dropdown.innerHTML = html;
    }
    
    // Toggle dropdown
    datePicker.addEventListener('click', function(e) {
        e.stopPropagation();
        if (dropdown.style.display === 'none') {
            generateCalendar();
            dropdown.style.display = 'block';
            
            // Position dropdown
            const rect = datePicker.getBoundingClientRect();
            dropdown.style.position = 'absolute';
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.left = rect.left + 'px';
        } else {
            dropdown.style.display = 'none';
        }
    });
    
    // Handle dropdown clicks
    dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
        
        if (e.target.classList.contains('day-cell') && !e.target.classList.contains('empty')) {
            const selectedDate = e.target.getAttribute('data-date');
            datePicker.value = selectedDate;
            updateDataIndicator(selectedDate);
            dropdown.style.display = 'none';
            
            // Navigate to date
            navigateToDate(selectedDate);
        } else if (e.target.classList.contains('month-nav')) {
            const dir = parseInt(e.target.getAttribute('data-dir'));
            const currentDate = new Date(datePicker.value + 'T12:00:00');
            currentDate.setMonth(currentDate.getMonth() + dir);
            datePicker.value = currentDate.toISOString().split('T')[0];
            generateCalendar();
        }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
        dropdown.style.display = 'none';
    });
    
    // Handle today button
    todayBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const today = new Date().toISOString().split('T')[0];
        datePicker.value = today;
        updateDataIndicator(today);
        dropdown.style.display = 'none';
        navigateToDate(today);
    });
    
    // Navigate to selected date
    function navigateToDate(selectedDate) {
        const currentUrl = new URL(window.location);
        const currentPage = currentUrl.pathname;
        
        const newUrl = new URL(currentPage, window.location.origin);
        newUrl.searchParams.set('date', selectedDate);
        
        // Preserve other query parameters
        const otherParams = ['type', 'job', 'result', 'sort', 'direction'];
        otherParams.forEach(param => {
            if (currentUrl.searchParams.has(param)) {
                newUrl.searchParams.set(param, currentUrl.searchParams.get(param));
            }
        });
        
        window.location.href = newUrl.toString();
    }
    
    // Append dropdown to body
    document.body.appendChild(dropdown);
});
</script>
<style>
    /* Date picker styles */
    .date-picker {
        cursor: pointer;
        background-color: white;
    }
    
    .date-picker.has-data {
        border-left: 3px solid #10b981;
        background-color: #f0fdf4;
    }
    
    /* Calendar dropdown */
    .date-dropdown {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        padding: 12px;
        z-index: 1000;
        min-width: 280px;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding: 8px;
    }
    
    .month-label {
        font-weight: 600;
        font-size: 0.95rem;
        color: #1f2937;
    }
    
    .month-nav {
        background: #f3f4f6;
        border: none;
        border-radius: 4px;
        padding: 4px 12px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
    }
    
    .month-nav:hover {
        background: #e5e7eb;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }
    
    .day-header {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #6b7280;
        padding: 8px 4px;
    }
    
    .day-cell {
        text-align: center;
        padding: 8px 4px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.875rem;
        transition: all 0.2s;
        position: relative;
    }
    
    .day-cell:not(.empty):hover {
        background: #f3f4f6;
    }
    
    .day-cell.has-data {
        background: #d1fae5;
        font-weight: 600;
        color: #065f46;
    }
    
    .day-cell.has-data:hover {
        background: #a7f3d0;
    }
    
    .day-cell.selected {
        background: #3b82f6;
        color: white;
        font-weight: 600;
    }
    
    .day-cell.empty {
        cursor: default;
    }
</style>
{{end}}
