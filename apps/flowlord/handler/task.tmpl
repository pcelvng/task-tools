<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowlord: Tasks</title>
    <link rel="icon" type="image/svg+xml" href="{{if .isLocal}}./static{{else}}/static{{end}}/favicon.svg">
    <link rel="stylesheet" href="{{if .isLocal}}./static{{else}}/static{{end}}/style.css">
</head>
<body>
    {{template "header" .}}
    <div class="container full-width">

        <div class="summary-section">
            <h3>Task Summary</h3>
            <div class="summary-stats">
                <div class="stat-card{{if not .Filter.Result}} active{{end}}" data-filter="all" onclick="filterByResult('all')">
                    <div class="stat-number">{{.Counts.Total}}</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card{{if eq .Filter.Result "complete"}} active{{end}}" data-filter="complete" onclick="filterByResult('complete')">
                    <div class="stat-number">{{.Counts.Completed}}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card{{if eq .Filter.Result "error"}} active{{end}}" data-filter="error" onclick="filterByResult('error')">
                    <div class="stat-number">{{.Counts.Error}}</div>
                    <div class="stat-label">Errors</div>
                </div>
                <div class="stat-card{{if eq .Filter.Result "alert"}} active{{end}}" data-filter="alert" onclick="filterByResult('alert')">
                    <div class="stat-number">{{.Counts.Alert}}</div>
                    <div class="stat-label">Alerts</div>
                </div>
                <div class="stat-card{{if eq .Filter.Result "warn"}} active{{end}}" data-filter="warn" onclick="filterByResult('warn')">
                    <div class="stat-number">{{.Counts.Warn}}</div>
                    <div class="stat-label">Warnings</div>
                </div>
                <div class="stat-card{{if eq .Filter.Result "running"}} active{{end}}" data-filter="running" onclick="filterByResult('running')">
                    <div class="stat-number">{{.Counts.Running}}</div>
                    <div class="stat-label">Running</div>
                </div>
            </div>
        </div>

        {{if gt .TotalPages 1}}
        <div class="pagination">
            <span class="pagination-info">Showing {{.StartIndex}}-{{.EndIndex}} of {{.FilteredCount}} {{if or .Filter.ID .Filter.Type .Filter.Job .Filter.Result}}filtered {{end}}tasks (Page {{.Page}} of {{.TotalPages}})</span>
            <div class="pagination-controls">
                {{if gt .Page 1}}
                <a href="?date={{.DateValue}}&page={{add .Page -1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Previous</a>
                {{end}}
                
                {{if lt .Page .TotalPages}}
                <a href="?date={{.DateValue}}&page={{add .Page 1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Next</a>
                {{end}}
            </div>
        </div>
        {{end}}

        <div class="filters">
            <h3>Filters</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="idFilter">Task ID</label>
                    <input type="text" id="idFilter" placeholder="Search by ID..." value="{{.Filter.ID}}">
                </div>
                <div class="filter-group">
                    <label for="typeFilter">Task Type</label>
                    <select id="typeFilter"{{if .Filter.ID}} disabled{{end}}>
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="jobFilter">Job</label>
                    <select id="jobFilter"{{if .Filter.ID}} disabled{{end}}>
                        <option value="">All Jobs</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button type="button" class="btn btn-primary" onclick="searchById()">Search ID</button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
                </div>
            </div>
        </div>

        {{if .Tasks}}
        <div class="table-container">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th class="sortable id-column" data-sort="id">ID</th>
                        <th class="sortable type-column" data-sort="type">Type</th>
                        <th class="sortable job-column" data-sort="job">Job</th>
                        <th class="sortable message-column" data-sort="message">Message</th>
                        <th class="sortable result-column" data-sort="result">Result</th>
                        <th class="sortable info-column" data-sort="info">Info</th>
                        <th class="sortable meta-column" data-sort="meta">Meta</th>
                        <th class="sortable created-column" data-sort="created">Created</th>
                        <th class="sortable queue-column" data-sort="queue_time">Queue</th>
                        <th class="sortable process-column" data-sort="task_time">Process</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Tasks}}
                    <tr>
                        <td class="id-cell id-column expandable" title="Click to expand">{{.ID}}</td>
                        <td class="type-cell type-column">{{.Type}}</td>
                        <td class="job-cell job-column">{{.Job}}</td>
                        <td class="message-cell message-column expandable" title="Click to expand">{{.Msg}}</td>
                        <td class="result-cell result-column {{if eq .Result "complete"}}result-complete{{else if eq .Result "error"}}result-error{{else if eq .Result "alert"}}result-alert{{else if eq .Result "warn"}}result-warn{{else}}result-running{{end}}">
                            {{if .Result}}{{.Result}}{{else}}Running{{end}}
                        </td>
                        <td class="info-cell info-column expandable" title="Click to expand">{{.Info}}</td>
                        <td class="meta-cell meta-column expandable" title="Click to expand">{{.Meta}}</td>
                        <td class="time-cell created-column">{{if .Created}}{{.Created}}{{else}}N/A{{end}}</td>
                        <td class="time-cell queue-column">{{if .QueueTime}}{{.QueueTime}}{{else}}N/A{{end}}</td>
                        <td class="time-cell process-column">{{if .TaskTime}}{{.TaskTime}}{{else}}N/A{{end}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        <div class="stats">
            {{if or .Filter.ID .Filter.Type .Filter.Job .Filter.Result}}
            Showing: <span id="visibleCount">{{len .Tasks}}</span> | Filtered Tasks: <span id="filteredCount">{{.FilteredCount}}</span> | Total Tasks: <span id="totalCount">{{.Counts.Total}}</span>
            {{else}}
            Showing: <span id="visibleCount">{{len .Tasks}}</span> | Total Tasks: <span id="totalCount">{{.Counts.Total}}</span>
            {{end}}
        </div>
        
        {{if gt .TotalPages 1}}
        <div class="pagination">
            <span class="pagination-info">Page {{.Page}} of {{.TotalPages}}</span>
            <div class="pagination-controls">
                {{if gt .Page 1}}
                <a href="?date={{.DateValue}}&page={{add .Page -1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Previous</a>
                {{end}}
                
                {{if lt .Page .TotalPages}}
                <a href="?date={{.DateValue}}&page={{add .Page 1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Next</a>
                {{end}}
            </div>
        </div>
        {{end}}
        {{else}}
        <div class="no-tasks">
            <h3>No tasks found</h3>
            <p>No tasks were found for {{.Date}} with the current filters.</p>
        </div>
        {{end}}
    </div>

    <script src="{{if .isLocal}}./static{{else}}/static{{end}}/task.js"></script>
    <script>
        // Initialize task page with server-provided configuration
        document.addEventListener('DOMContentLoaded', function() {
            if (window.FlowlordTask) {
                const config = {
                    taskTypes: [{{range $i, $t := .UniqueTypes}}{{if $i}},{{end}}"{{$t}}"{{end}}],
                    jobsByType: [
                        {{range $type, $jobs := .JobsByType}}
                        ["{{$type}}", [{{range $j, $job := $jobs}}{{if $j}},{{end}}"{{$job}}"{{end}}]],
                        {{end}}
                    ],
                    currentType: "{{.Filter.Type}}",
                    currentJob: "{{.Filter.Job}}"
                };
                window.FlowlordTask.init(config);
            }

            // Enable Enter key for ID search
            const idFilter = document.getElementById('idFilter');
            if (idFilter) {
                idFilter.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchById();
                    }
                });
            }
        });

        // Search by task ID - resets other filters
        function searchById() {
            const idValue = document.getElementById('idFilter').value.trim();
            if (idValue) {
                window.location.href = '?date={{.DateValue}}&id=' + encodeURIComponent(idValue);
            }
        }
    </script>
</body>
</html>
