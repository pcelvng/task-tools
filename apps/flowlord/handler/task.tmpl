<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowlord: Tasks</title>
    <link rel="icon" type="image/svg+xml" href="{{if .isLocal}}./static{{else}}/static{{end}}/favicon.svg">
    <link rel="stylesheet" href="{{if .isLocal}}./static{{else}}/static{{end}}/style.css">
</head>
<body>
    {{template "header" .}}
    <div class="container full-width">

        <div class="summary-section">
            <h3>Summary</h3>
            {{if .HourlyStats}}
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible('hourlyChart')">
                    <h3>Hourly Task Breakdown</h3>
                    <span class="collapsible-toggle" id="hourlyChart-toggle">â–¼</span>
                </div>
                <div class="collapsible-content" id="hourlyChart-content">
                    <div class="chart-container">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>
            {{end}}
            <div class="summary-stats-text">
                <span class="summary-stat-item">
                    <span class="stat-color-box stat-total"></span>
                    Total: {{.Counts.Total}}
                </span>
                <span class="summary-stat-item">
                    <span class="stat-color-box stat-completed"></span>
                    Completed: {{.Counts.Completed}}
                </span>
                <span class="summary-stat-item">
                    <span class="stat-color-box stat-error"></span>
                    Errors: {{.Counts.Error}}
                </span>
                <span class="summary-stat-item">
                    <span class="stat-color-box stat-alert"></span>
                    Alerts: {{.Counts.Alert}}
                </span>
                <span class="summary-stat-item">
                    <span class="stat-color-box stat-warn"></span>
                    Warnings: {{.Counts.Warn}}
                </span>
                <span class="summary-stat-item">
                    <span class="stat-color-box stat-running"></span>
                    Running: {{.Counts.Running}}
                </span>
            </div>
        </div>

        {{if gt .TotalPages 1}}
        <div class="pagination">
            <span class="pagination-info">Showing {{.StartIndex}}-{{.EndIndex}} of {{.FilteredCount}} {{if or .Filter.ID .Filter.Type .Filter.Job .Filter.Result}}filtered {{end}}tasks (Page {{.Page}} of {{.TotalPages}})</span>
            <div class="pagination-controls">
                {{if gt .Page 1}}
                <a href="?date={{.DateValue}}&page={{add .Page -1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Previous</a>
                {{end}}
                
                {{if lt .Page .TotalPages}}
                <a href="?date={{.DateValue}}&page={{add .Page 1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Next</a>
                {{end}}
            </div>
        </div>
        {{end}}

        <div class="filters">
            <h3>Filters</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="idFilter">Task ID</label>
                    <input type="text" id="idFilter" placeholder="Search by ID..." value="{{.Filter.ID}}">
                </div>
                <div class="filter-group">
                    <label for="typeFilter">Task Type</label>
                    <select id="typeFilter"{{if .Filter.ID}} disabled{{end}}>
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="jobFilter">Job</label>
                    <select id="jobFilter"{{if .Filter.ID}} disabled{{end}}>
                        <option value="">All Jobs</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="resultFilter">Result</label>
                    <select id="resultFilter"{{if .Filter.ID}} disabled{{end}}>
                        <option value="">All Results</option>
                        <option value="complete"{{if eq .Filter.Result "complete"}} selected{{end}}>Completed</option>
                        <option value="error"{{if eq .Filter.Result "error"}} selected{{end}}>Errors</option>
                        <option value="alert"{{if eq .Filter.Result "alert"}} selected{{end}}>Alerts</option>
                        <option value="warn"{{if eq .Filter.Result "warn"}} selected{{end}}>Warnings</option>
                        <option value="running"{{if eq .Filter.Result "running"}} selected{{end}}>Running</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button type="button" class="btn btn-primary" onclick="searchById()">Search ID</button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
                </div>
            </div>
        </div>

        {{if .Tasks}}
        <div class="table-container">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th class="sortable id-column" data-sort="id">ID</th>
                        <th class="sortable type-column" data-sort="type">Type</th>
                        <th class="sortable job-column" data-sort="job">Job</th>
                        <th class="sortable message-column" data-sort="message">Message</th>
                        <th class="sortable result-column" data-sort="result">Result</th>
                        <th class="sortable info-column" data-sort="info">Info</th>
                        <th class="sortable meta-column" data-sort="meta">Meta</th>
                        <th class="sortable created-column" data-sort="created">Created</th>
                        <th class="sortable queue-column" data-sort="queue_time">Queue</th>
                        <th class="sortable process-column" data-sort="task_time">Process</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Tasks}}
                    <tr>
                        <td class="id-cell id-column expandable" title="Click to expand">{{.ID}}</td>
                        <td class="type-cell type-column">{{.Type}}</td>
                        <td class="job-cell job-column">{{.Job}}</td>
                        <td class="message-cell message-column expandable" title="Click to expand">{{.Msg}}</td>
                        <td class="result-cell result-column {{if eq .Result "complete"}}result-complete{{else if eq .Result "error"}}result-error{{else if eq .Result "alert"}}result-alert{{else if eq .Result "warn"}}result-warn{{else}}result-running{{end}}">
                            {{if .Result}}{{.Result}}{{else}}Running{{end}}
                        </td>
                        <td class="info-cell info-column expandable" title="Click to expand">{{.Info}}</td>
                        <td class="meta-cell meta-column expandable" title="Click to expand">{{.Meta}}</td>
                        <td class="time-cell created-column">{{if .Created}}{{.Created}}{{else}}N/A{{end}}</td>
                        <td class="time-cell queue-column">{{if .QueueTime}}{{.QueueTime}}{{else}}N/A{{end}}</td>
                        <td class="time-cell process-column">{{if .TaskTime}}{{.TaskTime}}{{else}}N/A{{end}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        <div class="stats">
            {{if or .Filter.ID .Filter.Type .Filter.Job .Filter.Result}}
            Showing: <span id="visibleCount">{{len .Tasks}}</span> | Filtered Tasks: <span id="filteredCount">{{.FilteredCount}}</span> | Total Tasks: <span id="totalCount">{{.Counts.Total}}</span>
            {{else}}
            Showing: <span id="visibleCount">{{len .Tasks}}</span> | Total Tasks: <span id="totalCount">{{.Counts.Total}}</span>
            {{end}}
        </div>
        
        {{if gt .TotalPages 1}}
        <div class="pagination">
            <span class="pagination-info">Page {{.Page}} of {{.TotalPages}}</span>
            <div class="pagination-controls">
                {{if gt .Page 1}}
                <a href="?date={{.DateValue}}&page={{add .Page -1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Previous</a>
                {{end}}
                
                {{if lt .Page .TotalPages}}
                <a href="?date={{.DateValue}}&page={{add .Page 1}}{{if .Filter.Type}}&type={{.Filter.Type}}{{end}}{{if .Filter.Job}}&job={{.Filter.Job}}{{end}}{{if .Filter.Result}}&result={{.Filter.Result}}{{end}}" class="btn btn-secondary">Next</a>
                {{end}}
            </div>
        </div>
        {{end}}
        {{else}}
        <div class="no-tasks">
            <h3>No tasks found</h3>
            <p>No tasks were found for {{.Date}} with the current filters.</p>
        </div>
        {{end}}
    </div>

    <script src="{{if .isLocal}}./static{{else}}/static{{end}}/task.js"></script>
    <script>
        // Initialize task page with server-provided configuration
        document.addEventListener('DOMContentLoaded', function() {
            if (window.FlowlordTask) {
                const config = {
                    taskTypes: [{{range $i, $t := .UniqueTypes}}{{if $i}},{{end}}"{{$t}}"{{end}}],
                    jobsByType: [
                        {{range $type, $jobs := .JobsByType}}
                        ["{{$type}}", [{{range $j, $job := $jobs}}{{if $j}},{{end}}"{{$job}}"{{end}}]],
                        {{end}}
                    ],
                    currentType: "{{.Filter.Type}}",
                    currentJob: "{{.Filter.Job}}"
                };
                window.FlowlordTask.init(config);
            }

            // Enable Enter key for ID search
            const idFilter = document.getElementById('idFilter');
            if (idFilter) {
                idFilter.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchById();
                    }
                });
            }

            // Render hourly task chart
            {{if .HourlyStats}}
            renderHourlyChart();
            
            // Re-render chart on window resize with debouncing
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    renderHourlyChart();
                }, 150);
            });
            {{end}}
        });

        function renderHourlyChart() {
            const canvas = document.getElementById('hourlyChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // Get hourly data from template
            const hourlyData = [
                {{range $i, $stats := .HourlyStats}}
                {
                    hour: {{$i}},
                    completed: {{$stats.Completed}},
                    error: {{$stats.Error}},
                    alert: {{$stats.Alert}},
                    warn: {{$stats.Warn}},
                    running: {{$stats.Running}},
                    total: {{$stats.Total}}
                },
                {{end}}
            ];

            // Chart dimensions and styling
            const padding = { top: 20, right: 40, bottom: 60, left: 60 };
            const dpr = window.devicePixelRatio || 1;
            
            // Set canvas size
            canvas.style.width = '100%';
            canvas.style.height = '400px';
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Calculate nice round max value with buffer
            function getNiceMax(value) {
                if (value === 0) return 20;
                
                // Add 12% buffer for visual spacing
                const buffered = value * 1.12;
                
                // Try nice intervals that divide evenly by 4
                // This gives us 5 grid lines with clean tick marks
                // intervals of: 5, 10, 25, 50, 75, 100, 125, 250, etc.
                const niceIntervals = [
                    5, 10, 25, 50, 75, 100, 125, 250, 500, 750, 
                    1000, 1250, 2500, 5000, 7500, 10000, 25000, 50000
                ];
                
                for (let interval of niceIntervals) {
                    const maxValue = interval * 4; // 4 intervals = 5 grid lines
                    if (maxValue >= buffered) {
                        return maxValue;
                    }
                }
                
                // For very large numbers, round up to nearest multiple of 100000
                return Math.ceil(buffered / 100000) * 100000;
            }
            
            // Find max total and round to nice number
            const actualMax = Math.max(...hourlyData.map(d => d.total), 1);
            const maxTotal = getNiceMax(actualMax);
            
            // Color scheme matching the summary cards
            const colors = {
                completed: '#4caf50',
                error: '#f44336',
                alert: '#ff9800',
                warn: '#ffc107',
                running: '#2196f3'
            };

            // Draw grid lines and y-axis labels
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#666';
            ctx.font = '12px system-ui, -apple-system, sans-serif';
            ctx.textAlign = 'right';
            
            // Use 4 intervals (5 lines including 0)
            const numIntervals = 4;
            const tickInterval = maxTotal / numIntervals;
            
            for (let i = 0; i <= numIntervals; i++) {
                const value = Math.round(tickInterval * i);
                const y = padding.top + chartHeight - (chartHeight / numIntervals) * i;
                
                // Draw grid line
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();
                
                // Draw y-axis label
                ctx.fillText(value.toString(), padding.left - 10, y + 4);
            }

            // Calculate bar width
            const barWidth = chartWidth / 24;
            const barPadding = barWidth * 0.1;
            const actualBarWidth = barWidth - barPadding;

            // Draw bars for each hour
            hourlyData.forEach((data, index) => {
                if (data.total === 0) return;

                const x = padding.left + (index * barWidth) + (barPadding / 2);
                const scale = chartHeight / maxTotal;
                
                let currentY = padding.top + chartHeight;

                // Stack the bars from bottom to top
                const segments = [
                    { value: data.completed, color: colors.completed },
                    { value: data.error, color: colors.error },
                    { value: data.alert, color: colors.alert },
                    { value: data.warn, color: colors.warn },
                    { value: data.running, color: colors.running }
                ];

                segments.forEach(segment => {
                    if (segment.value > 0) {
                        const segmentHeight = segment.value * scale;
                        currentY -= segmentHeight;
                        
                        ctx.fillStyle = segment.color;
                        ctx.fillRect(x, currentY, actualBarWidth, segmentHeight);
                    }
                });
            });

            // Draw x-axis labels (hours)
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.font = '11px system-ui, -apple-system, sans-serif';
            
            for (let i = 0; i < 24; i++) {
                const x = padding.left + (i * barWidth) + (barWidth / 2);
                const label = i.toString().padStart(2, '0');
                ctx.fillText(label, x, padding.top + chartHeight + 20);
            }

            // Draw axis labels
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px system-ui, -apple-system, sans-serif';
            
            // X-axis label
            ctx.textAlign = 'center';
            ctx.fillText('Hour of Day', width / 2, height - 10);
            
            // Y-axis label
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Number of Tasks', 0, 0);
            ctx.restore();
        }

        // Search by task ID - resets other filters
        function searchById() {
            const idValue = document.getElementById('idFilter').value.trim();
            if (idValue) {
                window.location.href = '?date={{.DateValue}}&id=' + encodeURIComponent(idValue);
            }
        }
    </script>
</body>
</html>
