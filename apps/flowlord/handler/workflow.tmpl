<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowlord: Workflows</title>
    <link rel="icon" type="image/svg+xml" href="{{if .isLocal}}./static{{else}}/static{{end}}/favicon.svg">
    <link rel="stylesheet" href="{{if .isLocal}}./static{{else}}/static{{end}}/style.css">
</head>
<body>
    {{template "header" .}}
    <div class="container full-width">

        <div class="summary-section">
            <h3>Workflow File Summary</h3>
            <div class="summary-grid">
                {{range $filePath, $count := .WorkflowFileSummary}}
                <div class="summary-card">
                    <div class="summary-header">
                        <span class="summary-key">{{$filePath}}</span>
                        <span class="summary-count">{{$count}} phases</span>
                    </div>
                    <div class="summary-details">Workflow file with {{$count}} phase{{if ne $count 1}}s{{end}}</div>
                </div>
                {{end}}
            </div>
        </div>

        <div class="filters">
            <h3>Filters</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="workflowFilter">Workflow File</label>
                    <select id="workflowFilter">
                        <option value="">All Workflows</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="taskFilter">Task Type</label>
                    <select id="taskFilter">
                        <option value="">All Tasks</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="jobFilter">Job</label>
                    <select id="jobFilter">
                        <option value="">All Jobs</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
                </div>
            </div>
        </div>

        {{if .Phases}}
        <div class="table-container">
            <table id="workflowTable">
                <thead>
                    <tr>
                        <th class="sortable workflow-file-cell" data-sort="workflow_file">Workflow</th>
                        <th class="sortable task-cell" data-sort="task">Topic</th>
                        <th class="sortable job-cell" data-sort="job">Job</th>
                        <th class="sortable rule-cell" data-sort="rule">Rule</th>
                        <th class="sortable depends-on-cell" data-sort="depends_on">Depends On</th>
                        <th class="sortable retry-cell" data-sort="retry">Retry</th>
                        <th class="sortable template-cell" data-sort="template">Template</th>
                        <th class="sortable status-cell" data-sort="status">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Phases}}
                    <tr>
                        <td class="workflow-file-cell">{{.FilePath}}</td>
                        <td class="task-cell">{{.Topic}}</td>
                        <td class="job-cell">{{.Job}}</td>
                        <td class="rule-cell truncated copyable" 
                            data-full-text="{{.Rule}}" 
                            data-truncated-text="{{if ge (len .Rule) 120}}{{slice .Rule 0 120}}...{{else}}{{.Rule}}{{end}}"
                            onclick="window.FlowlordUtils.toggleField(this, '{{.Rule}}')" 
                            oncontextmenu="window.FlowlordUtils.showContextMenu(event, '{{.Rule}}')"
                            ondblclick="window.FlowlordUtils.copyToClipboard('{{.Rule}}')"
                            title="Click to expand/collapse, double-click or right-click to copy">
                            {{if ge (len .Rule) 120}}{{slice .Rule 0 120}}...{{else}}{{.Rule}}{{end}}
                        </td>
                        <td class="depends-on-cell">{{.DependsOn}}</td>
                        <td class="retry-cell">{{.Retry}}</td>
                        <td class="template-cell truncated copyable" 
                            data-full-text="{{.Template}}" 
                            data-truncated-text="{{if ge (len .Template) 120}}{{slice .Template 0 120}}...{{else}}{{.Template}}{{end}}"
                            onclick="window.FlowlordUtils.toggleField(this, '{{.Template}}')" 
                            oncontextmenu="window.FlowlordUtils.showContextMenu(event, '{{.Template}}')"
                            ondblclick="window.FlowlordUtils.copyToClipboard('{{.Template}}')"
                            title="Click to expand/collapse, double-click or right-click to copy">
                            {{if ge (len .Template) 120}}{{slice .Template 0 120}}...{{else}}{{.Template}}{{end}}
                        </td>
                        <td class="status-cell">
                            <span class="{{if .Status}}result-error{{else}}result-complete{{end}}">
                                {{if .Status}}{{.Status}}{{else}}OK{{end}}
                            </span>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        <div class="stats">
            Total Phases: <span id="totalCount">{{len .Phases}}</span>
        </div>
        {{else}}
        <div class="no-tasks">
            <h3>No workflow phases found</h3>
            <p>No workflow phases were found in the database.</p>
        </div>
        {{end}}
    </div>

    <script src="{{if .isLocal}}./static{{else}}/static{{end}}/table-sort.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize table sorting
            window.FlowlordTableSort.init('workflowTable', {
                columnTypes: {
                    'retry': 'number'
                }
            });

            // Initialize filters
            initializeFilters();
        });

        // Initialize responsive filters
        function initializeFilters() {
            const workflowFilter = document.getElementById('workflowFilter');
            const taskFilter = document.getElementById('taskFilter');
            const jobFilter = document.getElementById('jobFilter');
            const table = document.getElementById('workflowTable');
            
            if (!table) return;
            
            // Get all workflow rows
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            // Extract unique values
            const workflows = new Set();
            const tasks = new Set();
            const jobMap = new Map(); // task -> Set of jobs
            
            rows.forEach(row => {
                const workflowCell = row.cells[0];
                const taskCell = row.cells[1];
                const jobCell = row.cells[2];
                
                if (workflowCell && taskCell && jobCell) {
                    const workflow = workflowCell.textContent.trim();
                    const task = taskCell.textContent.trim();
                    const job = jobCell.textContent.trim();
                    
                    if (workflow) workflows.add(workflow);
                    if (task) {
                        tasks.add(task);
                        if (!jobMap.has(task)) {
                            jobMap.set(task, new Set());
                        }
                        if (job) {
                            jobMap.get(task).add(job);
                        }
                    }
                }
            });
            
            // Populate workflow dropdown
            Array.from(workflows).sort().forEach(workflow => {
                const option = document.createElement('option');
                option.value = workflow;
                option.textContent = workflow;
                workflowFilter.appendChild(option);
            });
            
            // Populate task dropdown
            Array.from(tasks).sort().forEach(task => {
                const option = document.createElement('option');
                option.value = task;
                option.textContent = task;
                taskFilter.appendChild(option);
            });
            
            // Store jobMap for later use
            window.workflowJobMap = jobMap;
            
            // Handle task change
            taskFilter.addEventListener('change', function() {
                const selectedTask = this.value;
                const jobOptions = jobFilter.querySelectorAll('option:not([value=""])');
                jobOptions.forEach(option => option.remove());
                
                if (selectedTask && window.workflowJobMap.has(selectedTask)) {
                    Array.from(window.workflowJobMap.get(selectedTask)).sort().forEach(job => {
                        const option = document.createElement('option');
                        option.value = job;
                        option.textContent = job;
                        jobFilter.appendChild(option);
                    });
                }
                
                filterTable();
            });
            
            // Handle filter changes
            workflowFilter.addEventListener('change', filterTable);
            jobFilter.addEventListener('change', filterTable);
            
            // Initial filter
            filterTable();
        }
        
        // Filter table based on current filter values
        function filterTable() {
            const workflowFilter = document.getElementById('workflowFilter');
            const taskFilter = document.getElementById('taskFilter');
            const jobFilter = document.getElementById('jobFilter');
            const table = document.getElementById('workflowTable');
            
            if (!table) return;
            
            const selectedWorkflow = workflowFilter ? workflowFilter.value : '';
            const selectedTask = taskFilter ? taskFilter.value : '';
            const selectedJob = jobFilter ? jobFilter.value : '';
            
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            rows.forEach(row => {
                const workflowCell = row.cells[0];
                const taskCell = row.cells[1];
                const jobCell = row.cells[2];
                
                if (workflowCell && taskCell && jobCell) {
                    const workflow = workflowCell.textContent.trim();
                    const task = taskCell.textContent.trim();
                    const job = jobCell.textContent.trim();
                    
                    const workflowMatch = !selectedWorkflow || workflow === selectedWorkflow;
                    const taskMatch = !selectedTask || task === selectedTask;
                    const jobMatch = !selectedJob || job === selectedJob;
                    
                    row.style.display = (workflowMatch && taskMatch && jobMatch) ? '' : 'none';
                }
            });
            
            updatePhaseCount();
        }
        
        // Update the displayed phase count
        function updatePhaseCount() {
            const table = document.getElementById('workflowTable');
            if (!table) return;
            
            const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => 
                row.style.display !== 'none'
            );
            
            const totalCountElement = document.getElementById('totalCount');
            if (totalCountElement) {
                totalCountElement.textContent = visibleRows.length;
            }
        }
        
        // Clear all filters
        function clearFilters() {
            const workflowFilter = document.getElementById('workflowFilter');
            const taskFilter = document.getElementById('taskFilter');
            const jobFilter = document.getElementById('jobFilter');
            
            if (workflowFilter) workflowFilter.value = '';
            if (taskFilter) taskFilter.value = '';
            if (jobFilter) {
                jobFilter.value = '';
                const jobOptions = jobFilter.querySelectorAll('option:not([value=""])');
                jobOptions.forEach(option => option.remove());
            }
            
            filterTable();
        }
    </script>
</body>
</html>
